You are a senior NixOS engineer. Work ONLY inside this VS Code workspace (repo bnixos).
DO NOT run any git commands. Do NOT commit or push. Just create/modify files.

GOAL:
Implement:
- GNOME + GDM (Wayland) installer ISO (Calamares) remains working
- Snap enabled and users are allowed to install snap apps (NO restrictions)
- Flatpak enabled with GNOME Software + proper portals
- Per-user baseline apps: LibreOffice + Chromium installed automatically on first login via Flatpak --user
- Vietnamese input method: IBus + Bamboo
- GNOME less “technical”: hide technical tools but keep essential functionality

REQUIREMENTS (IMPLEMENT EXACTLY):

1) Per-user baseline apps (Flatpak):
- On first login for ANY user, auto-install via Flatpak --user:
  - org.libreoffice.LibreOffice
  - org.chromium.Chromium
- Add Flathub per-user remote if missing:
  - https://dl.flathub.org/repo/flathub.flatpakrepo
- Must be idempotent: create marker file:
  - ~/.config/bnixos/.flatpak_bootstrapped
- Must NOT require sudo
- Must be safe offline:
  - If network unavailable, exit 0 (no failure loops), and retry next login

2) Vietnamese typing:
- Enable IBus and Bamboo engine system-wide so GNOME can use it immediately:
  - i18n.inputMethod.enabled = "ibus"
  - include bamboo engine

3) GNOME lockdown / de-tech menu:
- Keep Settings, Files, GNOME Software, networking, bluetooth, printers.
- Exclude these packages from GNOME default menu:
  - gnome-terminal
  - gnome-system-monitor
  - gnome-logs
  - gnome-disk-utility
  - gnome-connections
- Disable “Run command” (Alt+F2) via dconf:
  - org/gnome/desktop/lockdown disable-command-line = true
- Ensure:
  - programs.dconf.enable = true

FILES / STRUCTURE:
Use existing structure if present; if missing, create:
- flake.nix
- iso.nix (imports installation-cd-graphical-calamares.nix)
- modules/
  - base.nix
  - desktop.nix            (IBus + Bamboo here)
  - users.nix
  - snap-flatpak.nix       (Flatpak+GNOME Software+portal + per-user bootstrap service here)
  - update-agent.nix
  - hardening.nix          (GNOME exclude packages + dconf lockdown here)
- version.txt (keep existing if already present)

SNAP RULE:
- Enable snapd (services.snap.enable = true)
- Enable AppArmor + squashfs
- DO NOT restrict snap install / snapctl in any way.

OUTPUT FORMAT:
- First show the final repository tree.
- Then output the full content of each file you created/modified.
- No explanations, no questions.

START NOW.
