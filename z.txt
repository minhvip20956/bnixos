You are a senior NixOS infrastructure engineer.

WORK MODE:
- Work ONLY inside this VS Code workspace (repo bnixos).
- The repository is EMPTY.
- CREATE and MODIFY files directly in the workspace.
- DO NOT run git commands.
- DO NOT commit or push.
- Output files by writing them into the workspace, not paste-only.

====================================================
GOAL
====================================================
Create a COMPLETE, PRODUCTION-READY NixOS INSTALLER ISO project
for enterprise laptops.

The result must be:
- A graphical NixOS installer ISO (Calamares)
- USB + EFI bootable
- After install: immutable, IT-controlled, user-safe
- Ready to build ISO immediately with one nix build command

====================================================
BASE SYSTEM
====================================================
- OS: NixOS 24.05 or newer
- Flakes ONLY (no channels)
- systemd-boot (UEFI)
- Rollback enabled, keep last 3 generations
- AppArmor enabled

====================================================
DESKTOP
====================================================
- GNOME (Wayland)
- GDM display manager
- GNOME stable from nixpkgs (no beta, no nightly)

====================================================
USERS
====================================================
- root:
  - Fixed password hash (placeholder OK)
- staff:
  - Normal user
  - NO sudo
  - Cannot run nix commands

====================================================
APPLICATION MODEL
====================================================
SNAP:
- Enable snapd
- Users ARE ALLOWED to install snap apps
- Do NOT restrict snap install or snapctl
- Enable squashfs + AppArmor

FLATPAK:
- Enable Flatpak
- Enable GNOME Software
- Enable xdg-desktop-portal for GNOME
- User-level Flatpak installs must work

BASELINE APPS (VERY IMPORTANT):
- For EACH USER, on FIRST LOGIN only:
  - Automatically install via Flatpak --user:
    - org.libreoffice.LibreOffice
    - org.chromium.Chromium
  - Add Flathub remote if missing:
    https://dl.flathub.org/repo/flathub.flatpakrepo
  - Must be idempotent using marker file:
    ~/.config/bnixos/.flatpak_bootstrapped
  - Must NOT require sudo
  - Must be SAFE when offline (exit cleanly, retry next login)

====================================================
VIETNAMESE INPUT
====================================================
- Enable IBus as input method framework
- Enable Bamboo engine
- Must work immediately in GNOME
- Telex / VNI supported

====================================================
GNOME LOCKDOWN (USER-FRIENDLY)
====================================================
- Keep essential features:
  - Settings
  - Files
  - GNOME Software
  - Networking / Bluetooth / Printers
- Remove / hide technical tools by excluding:
  - gnome-terminal
  - gnome-system-monitor
  - gnome-logs
  - gnome-disk-utility
  - gnome-connections
- Disable GNOME command prompt (Alt+F2):
  - org/gnome/desktop/lockdown disable-command-line = true
- Ensure programs.dconf.enable = true

====================================================
IT-CONTROLLED UPDATE MODEL (CRITICAL)
====================================================
- Implement pull-based update agent:
  - systemd oneshot service + timer
  - Runs as root
  - Polls THIS EXACT URL for version flag:
    https://raw.githubusercontent.com/minhvip20956/bnixos/main/version.txt
  - Add cache-bypass query (?t=timestamp)
  - If remote version != local version:
    - nix flake update /etc/nixos
    - nixos-rebuild switch --flake /etc/nixos#$(hostname)
    - Store version in: /var/lib/it-update/version
  - Must be SAFE when offline (no failure loops)

====================================================
INSTALLER ISO
====================================================
- Use Calamares graphical installer
- Import:
  <nixpkgs/nixos/modules/installer/cd-dvd/installation-cd-graphical-calamares.nix>
- ISO filename:
  bnixos-installer.iso
- EFI + USB bootable

====================================================
FILES / STRUCTURE TO CREATE
====================================================
- flake.nix
- iso.nix
- version.txt (initial content example: 2025-12-18-prod-001)
- modules/
  - base.nix
  - desktop.nix
  - users.nix
  - snap-flatpak.nix
  - update-agent.nix
  - hardening.nix
- README.md with:
  - How to install Nix on Rocky Linux
  - How to enable flakes
  - Exact nix build command
  - Where the ISO output is located

====================================================
QUALITY RULES
====================================================
- Valid Nix syntax ONLY
- Clean, production-ready code
- English comments inside code
- No TODOs (except password hash)
- Do NOT ask questions
- Do NOT explain concepts

====================================================
OUTPUT
====================================================
1) Show final repository tree
2) Output FULL content of each created/modified file

START NOW.
